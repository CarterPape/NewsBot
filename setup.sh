#!/bin/bash

project_path="$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

pip install -r "$project_path/requirements.txt"

if command -v apt-get 2>/dev/null; then
    sudo apt update -y
    sudo apt-get install -y libmagic-dev
    
    sudo apt-get install -y mariadb-server
elif command -v brew 2>/dev/null; then
    brew install libmagic
    brew install mariadb
else 
    printf "This project requires libmagic and MariaDB (or MySQL). "
    printf "Install them or ensure they are already installed, then hit [Enter] to continue. "
    read
fi

printf "Come up with a clever password for 'newsbot'@'localhost' (the MariaDB user for NewsBot) "
printf "or enter the existing password: "
stty -echo
read -p $mariadb_password
stty echo

sudo mysql -u root << EOF
CREATE USER 'newsbot'@'localhost' IDENTIFIED BY '$mariadb_password';
CREATE DATABASE newsbot;
GRANT ALL PRIVILEGES ON newsbot.* TO 'newsbot'@'localhost';
EOF

printf "Now that the new user and database have been created, do you want to secure the root user? "
select answer in "Yes" "No"; do
    case $answer in
        Yes ) sudo mysql_secure_installation; break;;
        No )  break;;
    esac
done

printf "\n"

rm "$project_path/.env" 2>/dev/null

printf "ENVIRONMENT = (probably: production) "
read -r environment

printf "EMAIL_RECIPIENT = (something like: Your Name <your@email.address>) "
read -r email_recipient
printf "EMAIL_SENDER = (something like: Your NewsBot <your-newsbot@your.newsbot.domain>) "
read -r email_sender
printf "EMAIL_SENDER_DOMAIN = (something like: your.newsbot.domain) "
read -r email_sender_domain

printf "MAILGUN_API_KEY = (check https://app.mailgun.com/app/account/security/api_keys) "
read -r mailgun_api_key

printf "# This document was generated by config.sh\n\n" >> "$project_path/.env"
printf "ENVIRONMENT='$environment'\n\n" >> "$project_path/.env"
printf "EMAIL_RECIPIENT='$email_recipient'\n" >> "$project_path/.env"
printf "EMAIL_SENDER='$email_sender'\n" >> "$project_path/.env"
printf "EMAIL_SENDER_DOMAIN='$email_sender_domain'\n\n" >> "$project_path/.env"
printf "MAILGUN_API_KEY='$mailgun_api_key'\n\n" >> "$project_path/.env"
printf "MYSQL_DATABASE='newsbot'\n" >> "$project_path/.env";
printf "MYSQL_USER='newsbot'\n" >> "$project_path/.env";
printf "MYSQL_PASSWORD='$mariadb_password'\n" >> "$project_path/.env";

chmod u=rw,g=,o= "$project_path/.env"

printf "$project_path/.env written\n"

printf "\n"

sudo rm -rf /usr/local/src/NewsBot 2>/dev/null
sudo ln -s $project_path /usr/local/src/NewsBot && \
    printf "Project linked in /usr/local/src/.\n"
    
sudo rm -rf /usr/local/lib/systemd/system/newsbot.service 2>/dev/null
sudo ln -s "$project_path/newsbot.service" /usr/local/lib/systemd/system/ && \
    printf "Service file linked in /usr/local/lib/systemd/system/.\n"

sudo systemctl enable newsbot
sudo systemctl start newsbot
